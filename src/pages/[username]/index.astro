---
import { createSupabaseClient } from "../../lib/supabase";
import MinimalistLayout from "../../templates/botanical/Layout.astro"; // Fallback layout, we will dynamically load components later or redirect.
// For the query-only requirement, we will fetch the data and set the headers.

const { username } = Astro.params;

// Access Cloudflare environment variables
// @ts-ignore
const locals = Astro.locals as any;
// @ts-ignore
const processEnv = typeof process !== "undefined" ? process.env : {};
const env = locals?.runtime?.env || processEnv;
const supabase = createSupabaseClient(env);

// 1. Fetch Profile
const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select("id, display_name, avatar_url")
    .eq("username", username)
    .single();

if (profileError || !profile) {
    return Astro.redirect("/404"); // Or returning a 404 response
}

// 2. Fetch Active Invitation for this profile
const { data: invitation, error: invitationError } = await supabase
    .from("invitations")
    .select("*")
    .eq("user_id", profile.id)
    .eq("is_active", true)
    .single();

if (invitationError || !invitation) {
    // If no active invitation, maybe they just have a profile but no event yet.
    return Astro.redirect("/404");
}

// 3. Set Cache Headers for Cloudflare CDN (The "Vitrina")
// Cache for 1 year (s-maxage=31536000), allowing stale data while revalidating (stale-while-revalidate)
// Cloudflare will serve this HTML to visitors instantly.
Astro.response.headers.set(
    "Cache-Control",
    "public, max-age=0, s-maxage=31536000, stale-while-revalidate"
);

// We determine which template to render based on invitation.template_id
// We import the correct Layout dynamically.
const templateId = invitation.template_id || "elegant";

// Pre-define imports so Astro/Vite knows about them statically
const templateComponents = {
    botanical: import("../../components/templates/botanical/index.astro"),
    brunch: import("../../components/templates/brunch/index.astro"),
    "harry-potter": import(
        "../../components/templates/harry-potter/index.astro"
    ),
    lavender: import("../../components/templates/lavender/index.astro"),
    scrapbook: import("../../components/templates/scrapbook/index.astro"),
    serenity: import("../../components/templates/serenity/index.astro"),
    western: import("../../components/templates/western/index.astro"),
};

type TemplateKey = keyof typeof templateComponents;

let TemplateComponent;

if (templateId in templateComponents) {
    const Component = await templateComponents[templateId as TemplateKey];
    TemplateComponent = Component.default;
} else {
    // Fallback if template doesn't exist
    return Astro.redirect("/404");
}
---

<TemplateComponent invitation={invitation} profile={profile} />
