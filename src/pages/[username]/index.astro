---
import { createSupabaseClient } from "../../lib/supabase";

const { username } = Astro.params;

// Access Cloudflare environment variables (prod) or import.meta.env (dev)
// @ts-ignore
const locals = Astro.locals as any;
const env = locals?.runtime?.env || import.meta.env;
const supabase = createSupabaseClient(env);

// ──────────────────────────────────────────────
// 1. Fetch Profile by username
// ──────────────────────────────────────────────
const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select("id, display_name, avatar_url, username")
    .eq("username", username)
    .single();

if (profileError || !profile) {
    return Astro.redirect("/404");
}

// ──────────────────────────────────────────────
// 2. Fetch the active user invitation
//    Join invitation_templates in a single query for defaults
// ──────────────────────────────────────────────
const { data: invitation, error: invitationError } = await supabase
    .from("invitations")
    .select(
        `
        *,
        invitation_templates (
            id,
            name,
            description,
            default_colors,
            default_custom_data
        )
    `
    )
    .eq("user_id", profile.id)
    .eq("is_active", true)
    .single();

if (invitationError || !invitation) {
    return Astro.redirect("/404");
}

// ──────────────────────────────────────────────
// 3. Merge template defaults with user overrides
//    User values always win; template provides the schema/fallbacks
// ──────────────────────────────────────────────
const templateDef = invitation.invitation_templates ?? {};
const mergedInvitation = {
    ...invitation,
    // Merge custom_data: template defaults first, user values override
    custom_data: {
        ...(templateDef.default_custom_data ?? {}),
        ...(invitation.custom_data ?? {}),
    },
    // Merge colors: template defaults first, user values override
    colors: {
        ...(templateDef.default_colors ?? {}),
        ...(invitation.colors ?? {}),
    },
};

// ──────────────────────────────────────────────
// 4. Set Cache-Control for Cloudflare CDN
// ──────────────────────────────────────────────
Astro.response.headers.set(
    "Cache-Control",
    "public, max-age=0, s-maxage=31536000, stale-while-revalidate"
);

// ──────────────────────────────────────────────
// 5. Dynamically import the correct template component
// ──────────────────────────────────────────────
const templateId = invitation.template_id || "botanical";

const templateComponents = {
    botanical: import("../../components/templates/botanical/index.astro"),
    brunch: import("../../components/templates/brunch/index.astro"),
    "harry-potter": import(
        "../../components/templates/harry-potter/index.astro"
    ),
    lavender: import("../../components/templates/lavender/index.astro"),
    scrapbook: import("../../components/templates/scrapbook/index.astro"),
    serenity: import("../../components/templates/serenity/index.astro"),
    western: import("../../components/templates/western/index.astro"),
};

type TemplateKey = keyof typeof templateComponents;

if (!(templateId in templateComponents)) {
    return Astro.redirect("/404");
}

const { default: TemplateComponent } = await templateComponents[
    templateId as TemplateKey
];
---

<TemplateComponent invitation={mergedInvitation} profile={profile} />
